<template>
  <v-app
    :dark="darkTheme"
    id="inspire">
    <div :class="[`login-container`, isMobile ? `mobile` : ``]">
      <div class="login-bg-img d-flex justify-center align-center">
        <v-layout
          :class="[
            `d-flex`,
            `justify-center`,
            `align-center`,
            `login-layout`,
            isMobile ? `mobile` : ``
          ]">
          <v-card
            :class="[
              `login-card`,
              `d-flex`,
              `justify-center`,
              `align-center`,
              isMobile ? `mobile` : ``
            ]"
            rounded="lg"
            flat>
            <v-col
              :class="[
                `h-100`,
                `pa-0`,
                `login-body`,
                isMobile ? `mobile` : ``
              ]">
              <div :class="[`login-form`, isMobile ? `mobile` : ``]">
                <v-card-text>
                  <v-form
                    class="pa-0"
                    ref="loginForm"
                    :v-model="rqirValid"
                    autocomplete="on"
                    lazy-validation>
                    <v-text-field
                      class="login-input-item"
                      variant="plain"
                      hide-details="false"
                      solo
                      placeholder="Username"
                      type="text"
                      autofocus
                      @keyup="keyupEvent"
                      @keydown="keydownEvent"
                      v-model="loginForm.account">
                      <template v-slot:prepend>
                        <v-img
                          :alt="platformName"
                          cover
                          :src="
                            require(`@/assets/images/${themeClass}/icon-id.png`)
                          "
                          style="width: 25px; height: 26px; opacity: 1"></v-img>
                      </template>
                    </v-text-field>
                    <v-text-field
                      class="login-input-item login-input-items"
                      variant="plain"
                      placeholder="Password"
                      type="password"
                      hide-details="true"
                      solo
                      autocomplete="on"
                      @keyup="keyupEvent"
                      @update:focused="isPwFocus = $event"
                      v-model="loginForm.password">
                      <v-tooltip
                        v-model="onPwToolTip"
                        activator="parent"
                        location="bottom"
                        :open-on-hover="false"
                        >{{ $t("common.capsTooltip") }}</v-tooltip
                      >
                      <template v-slot:prepend>
                        <v-img
                          class="icon-password"
                          :alt="platformName"
                          cover
                          :src="
                            require(`@/assets/images/${themeClass}/icon-lock.png`)
                          "></v-img>
                      </template>
                    </v-text-field>
                    <v-checkbox
                      v-if="false"
                      class="auto-login d-flex justify-end"
                      :v-model="isAuto"
                      @click="getAuto"
                      :label="this.$t(`login.autoLogin`)"></v-checkbox>
                  </v-form>
                </v-card-text>

                <v-card-actions class="d-flex align-center">
                  <v-btn
                    class="bg-login-btn-bg text-login-btn-text w-100 mt-5 login-btn"
                    :loading="loading"
                    @click.prevent="handleLogin">
                    Sign in
                  </v-btn>
                </v-card-actions>
              </div>
            </v-col>
          </v-card>
        </v-layout>
      </div>
    </div>
    <progress />
  </v-app>
</template>

<script>
  import common from "@/utils/common";
  import {mapGetters, mapState} from "vuex";
  export default {
    name: "Login",
    data() {
      return {
        isAuto: false,
        isMobile: false,
        isShiftKey: false,
        rqirValid: false,
        darkTheme: true,
        platformName: "Login",
        loginForm: {
          account: "",
          password: "",
          code: "",
          origin: "password",
          currentPlatformType: ""
        },
        loginRules: {
          account: [(v) => !!v || this.$t("login.accountTip")],
          password: [(v) => !!v || this.$t("login.passwordTip")],
          currentPlatformType: [
            {
              required: true,
              trigger: "blur",
              message: this.$t("login.selectPlatform")
            }
          ],
          code: [
            {
              required: true,
              trigger: "blur",
              message: this.$t("login.codeTip")
            }
          ]
        },
        timestamp: "",
        isCapsLock: false,
        isPwFocus: false,
        loading: false,
        redirect: undefined,
        otherQuery: {}
      };
    },
    computed: {
      ...mapState({
        themeClass: (state) => state.settings.themeClass
      }),
      sysConfig() {
        return this.$store.state.settings.sysConfig;
      },
      onPwToolTip() {
        return this.isCapsLock && this.isPwFocus;
      }
    },
    watch: {
      $route: {
        handler: function (route) {
          const query = route.query;
          if (query) {
            this.redirect = query.redirect;
            this.otherQuery = this.getOtherQuery(query);
          }
        },
        immediate: true
      }
      // 연속 키 입력 시 중복 입력되는 문제로 주석처리함.
      // input event로 대체해도 동일 문제 발생
      // loginForm: {
      //   deep: true,
      //   handler(n) {
      //     if (n.account) {
      //       let enValue = this.$inko.ko2en(n.account);
      //       enValue = enValue.slice(-1);
      //       enValue =
      //         this.isShiftKey || this.isCapsLock
      //           ? enValue.toUpperCase()
      //           : enValue;
      //       enValue = n.account.slice(0, -1) + enValue;
      //       this.loginForm.account = enValue;
      //     }
      //   }
      // }
    },
    created() {},
    mounted() {
      window.addEventListener("resize", this.handleResize);
      this.handleResize();
    },
    beforeUnmount() {
      window.removeEventListener("resize", this.handleResize);
    },
    unmounted() {
      // document.onkeydown = function (e) {
      //   const {keyCode} = e;
      //   if (keyCode === 13) {
      //   }
      // };
    },
    methods: {
      getAuto() {
        this.isAuto = !this.isAuto;
      },
      handleResize(event) {
        const width = window.innerWidth;
        this.isMobile = width < 900 ? true : false;
      },
      keyupEvent(e) {
        const {key} = e;
        if (key && key === "Enter") {
          this.handleLogin();
        } else if (key && key === "Shift") {
          this.isShiftKey = false;
        }

        this.isCapsLock = e.getModifierState("CapsLock");
      },
      keydownEvent(e) {
        const {key} = e;
        if (key && key === "Shift") {
          this.isShiftKey = true;
        }
      },
      async handleLogin() {
        if (this.loading) return;
        const valid = common.validation(this.loginForm, this.loginRules);

        if (typeof valid === "string") {
          this.$alert({
            title: this.$t("wcs.common.alertTitle.loginFail"),
            message: valid
          });
          return false;
        }

        if (valid) {
          this.loading = true;
          this.$store.commit("app/SET_LOADING", {loading: true});
          const query = {
            ...this.loginForm,
            timestamp: this.timestamp,
            layoutType: this.isMobile ? "mobile" : "classic"
          };
          localStorage.setItem("centerCode", "");
          localStorage.setItem("isAuto", this.isAuto);
          localStorage.setItem("loadTime", new Date());
          await this.$store
            .dispatch("user/login", query)
            .then((res) => {
              localStorage.setItem("centerCode", res.centerCode);

              // this.$store.commit("user/SET_USERINFO", res);
              // this.$store.commit("user/SET_MENULIST", res.menus);

              localStorage.setItem(
                "currentPlatformType",
                this.loginForm.currentPlatformType
              );

              const pathUrl =
                res.deviceType === "pad"
                  ? "/pad/padIndexPage"
                  : // : res.deviceType === "kiosk"
                  // ? "/kiosk/kioskIndexPage"
                  res.deviceType === "pda" || this.isMobile
                  ? "/pda/pdaBoxMapping"
                  : res.indexPage;

              // permission router beforeEach getUserInfo
              this.$router.push({
                path: this.redirect || pathUrl,
                query: this.otherQuery
              });
            })
            .catch((e) => {
              if (e.message) {
                e.message.title = this.$t("wcs.common.alertTitle.loginFail");
                this.$alert(e.message);
              }
            });
          this.loading = false;
          this.$store.commit("app/SET_LOADING", {loading: false});
        } else {
          return false;
        }
      },
      getOtherQuery(query) {
        return Object.keys(query).reduce((acc, cur) => {
          if (cur !== "redirect") {
            acc[cur] = query[cur];
          }
          return acc;
        }, {});
      }
    }
  };
</script>

<style
  lang="scss"
  scoped>
  .login-container {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100vw;
    height: 100vh;

    ::v-deep .v-responsive__sizer {
      flex: none !important;
    }
  }
  .login-container {
    background-color: black;
  }

  .login-bg-img {
    width: 100vw;
    height: 100vh;
    position: relative;
  }
  .login-bg-img::before {
    content: "";
    background: url("../../assets/images/img-background.png");
    background-size: cover;
    opacity: 0.4;
    position: absolute;
    top: 0px;
    left: 0px;
    right: 0px;
    bottom: 0px;
  }

  .login-card {
    width: 40%;
    background-color: rgba(var(--v-theme-login-body-bg), 0);
  }
  .login-card.mobile {
    border-left: none;
  }

  .mobile {
    width: 100%;
    height: 100%;
  }

  .login-body {
    width: 100%;
    .login-form:not(.mobile) {
      padding: 10%;

      .v-card-text,
      .v-card-actions {
        padding: 0px;
      }
    }
    .login-form.mobile {
      // display: grid;
      align-items: center;
      margin-top: 10%;
      padding: 0 1% !important;
    }
    .login-input-item {
      // 로그인 id, pw input 스타일
      width: 100%;
      height: 80px;
      background-color: rgba(var(--v-theme-login-input-bg), 0);
      padding: 4px 40px 0 40px;
      margin-bottom: 25px;
      border-radius: 30px;
      border: solid 2px #fff;
      opacity: 0.8;

      // 로그인 id, pw 폰트
      font-family: "Spoqa Han Sans Neo" !important;
      font-weight: normal !important;
      font-stretch: normal !important;
      font-style: normal !important;
      line-height: 1.3 !important;
      letter-spacing: 1.15px !important;
      text-align: left !important;
      color: rgba(var(--v-theme-login-input-text), 1) !important;
      ::v-deep .v-field__input {
        font-size: 20px !important;
      }
      ::v-deep .v-img {
        margin-top: 6px;
      }
    }
    .login-btn {
      // 로그인 버튼 스타일
      padding: 27px 0;
      height: 80px;
      border-radius: 30px;
      text-transform: none;

      ::v-deep .v-btn__content {
        // 로그인 버튼 폰트
        width: 57px;
        height: 26px;
        font-family: "Spoqa Han Sans Neo";
        font-size: 23px;
        font-weight: normal;
        font-stretch: normal;
        font-style: normal;
        line-height: 1.3;
        letter-spacing: 1.15px;
        text-align: left;
        color: rgba(var(--v-theme-login-btn-text), 1);
      }
    }
  }

  .icon-password {
    width: 20px;
    height: 26px;
    margin: 5px 2px 0 2px;
    opacity: 1;
  }

  .login-body.mobile {
    width: 100%;
    float: none;
  }
  .auto-login {
    color: #fff;
    margin-bottom: 25px;
  }
  .login-input-items {
    margin-bottom: 0 !important;
  }
</style>
